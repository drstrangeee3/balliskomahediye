<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AbdÃ¼lsamed'in BalÄ±nÄ± Kurtarma MacerasÄ±</title>
    <style>
        body { margin: 0; padding: 0; background-color: #000; overflow: hidden; }
        canvas { display: block; margin: auto; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
</head>
<body>

<script>
    // --- 1. GÄ°RÄ°Åž EKRANI (DÃœZELTÄ°LMÄ°Åž VERSÄ°YON) ---
    class MainMenu extends Phaser.Scene {
        constructor() { super('MainMenu'); }
        preload() {
            this.load.image('sky', './ParallaxBackground/sky.png');
            this.load.image('kafaben', './kafaben.png');
            this.load.image('kafabal', './kafabal.png');
            this.load.image('ninja_ben', './ninja_ben.png');
            this.load.image('ninja_bal', './ninja_bal.png');
        }
        create() {
            const { width, height } = this.scale;
            
            // Arka Plan
            this.add.rectangle(0, 0, width, height, 0x87CEEB).setOrigin(0);
            if(this.textures.exists('sky')) this.add.image(width/2, height/2, 'sky').setDisplaySize(width, height);

            // BaÅŸlÄ±k
            this.add.text(width/2, 60, 'AbdÃ¼lsamed ve GÃ¼lmira', {
                fontFamily: 'Arial Black', fontSize: '32px', color: '#ffffff', stroke: '#000000', strokeThickness: 6
            }).setOrigin(0.5);

            // Bank
            const benchY = height - 100;
            this.add.rectangle(width/2, benchY, 200, 15, 0x5c3a21); // Oturak
            this.add.rectangle(width/2-80, benchY+20, 10, 40, 0x3d2b1f); // Ayak
            this.add.rectangle(width/2+80, benchY+20, 10, 40, 0x3d2b1f); // Ayak

            // --- KARAKTERLER ---
            // AbdÃ¼lsamed (Solda)
            this.createFullChar(width/2 - 50, benchY, 'ninja_ben', 'kafaben');
            // GÃ¼lmira (SaÄŸda)
            this.createFullChar(width/2 + 50, benchY, 'ninja_bal', 'kafabal');

            // --- BUTON (KONUMU DÃœZELTÄ°LDÄ°) ---
            // ArtÄ±k ekranÄ±n ortasÄ±nda, karakterlerin Ã¼stÃ¼nde duracak
            const btn = this.add.container(width/2, height / 2 - 30);
            
            const bg = this.add.rectangle(0,0, 220, 60, 0x8B4513);
            bg.setStrokeStyle(4, 0x5c3a21); // Ã‡erÃ§eve ekledim daha ÅŸÄ±k olsun
            
            const txt = this.add.text(0,0, 'MACERAYA BAÅžLA', {
                fontSize:'20px', fontStyle:'bold', fontFamily:'Arial'
            }).setOrigin(0.5);
            
            btn.add([bg, txt]).setSize(220,60).setInteractive({ useHandCursor: true })
               .on('pointerdown', () => {
                   // TÄ±klama efekti
                   this.tweens.add({ targets: btn, scaleX: 0.9, scaleY: 0.9, duration: 100, yoyo: true, onComplete: () => this.scene.start('StoryScene') });
               });
        }

        createFullChar(x, y, bodyKey, headKey) {
            const con = this.add.container(x, y);
            
            // VarsayÄ±lan Ayarlar
            let bodyY = -40;
            let headY = -75;

            // --- KÄ°ÅžÄ°YE Ã–ZEL AYARLAR ---
            if (bodyKey === 'ninja_ben') {
                // AbdÃ¼lsamed: KafasÄ± Ã§ok yukarÄ±daydÄ±, aÅŸaÄŸÄ± indiriyoruz.
                headY = -55; 
            }
            else if (bodyKey === 'ninja_bal') {
                // GÃ¼lmira: VÃ¼cudu gÃ¶mÃ¼lÃ¼ydÃ¼, yukarÄ± Ã§ekiyoruz.
                bodyY = -55;
                // VÃ¼cut yukarÄ± Ã§Ä±kÄ±nca kafa da onunla orantÄ±lÄ± yukarÄ± Ã§Ä±kmalÄ±
                headY = -55; 
            }

            const body = this.textures.exists(bodyKey) ? this.add.image(0, bodyY, bodyKey) : this.add.rectangle(0, bodyY, 40, 80, 0x00ff00);
            const head = this.add.image(0, headY, headKey).setDisplaySize(50,50);
            
            con.add([body, head]);
            
            // Nefes Alma Animasyonu
            this.tweens.add({
                targets: con, scaleY: 0.98, scaleX: 1.02, duration: 1500, yoyo: true, repeat: -1, ease: 'Sine.easeInOut'
            });
        }
    }

    // --- 2. HÄ°KAYE SAHNESÄ° (AYRI AYARLI VERSÄ°YON) ---
    class StoryScene extends Phaser.Scene {
        constructor() { super('StoryScene'); }
        preload() {
            this.load.image('ninja_ben', './ninja_ben.png'); 
            this.load.image('ninja_bal', './ninja_bal.png');
            this.load.image('iskelet', './iskelet.png');
        }
        create() {
            const { width, height } = this.scale;
            this.add.rectangle(0,0,width,height,0x4e342e).setOrigin(0);
            const floorY = height - 50;
            this.add.rectangle(width/2, floorY+25, width, 50, 0x221100);

            // Karakterleri oluÅŸtur
            this.conBen = this.createChar(width/2 - 100, floorY, 'ninja_ben', 'kafaben');
            this.conBal = this.createChar(width/2 + 100, floorY, 'ninja_bal', 'kafabal');
            
            // Ä°skelet
            this.enemy = this.add.image(width + 100, floorY - 40, this.textures.exists('iskelet') ? 'iskelet' : 'ninja_ben');
            if(this.textures.exists('iskelet')) { this.enemy.displayHeight = 100; this.enemy.scaleX = this.enemy.scaleY; }

            // KonuÅŸma BalonlarÄ±
            this.time.delayedCall(1000, () => this.speak(this.conBen, "AÅŸkitom, ben uyumaya gidiyorum."));
            this.time.delayedCall(3000, () => this.speak(this.conBal, "TamamdÄ±r aÅŸkÄ±m, geliyorum."));
            
            // KaÃ§Ä±rÄ±lma Animasyonu
            this.time.delayedCall(5000, () => {
                this.tweens.add({
                    targets: this.enemy, x: this.conBal.x + 30, duration: 1000,
                    onComplete: () => {
                        this.conBal.y -= 20;
                        this.tweens.add({
                            targets: [this.enemy, this.conBal], x: width + 200, y: -50, duration: 1500,
                            onComplete: () => {
                                const exc = this.add.text(this.conBen.x, this.conBen.y-100, '!', {fontSize:'60px', color:'red'}).setOrigin(0.5);
                                this.time.delayedCall(1000, () => { exc.destroy(); this.scene.start('GameScene'); });
                            }
                        });
                    }
                });
            });
        }

        createChar(x, y, bodyKey, headKey) {
            const con = this.add.container(x, y);

            // --- AYARLARI BURADAN YAP ---
            let bodyOffset = -40; // VarsayÄ±lan
            let headOffset = -75; // VarsayÄ±lan

            if (bodyKey === 'ninja_ben') {
                // --- ABDÃœLSAMED AYARLARI ---
                bodyOffset = -40;  // VÃ¼cut YÃ¼ksekliÄŸi (SayÄ± kÃ¼Ã§Ã¼lÃ¼rse yukarÄ± Ã§Ä±kar)
                headOffset = -60;  // Kafa YÃ¼ksekliÄŸi (AbdÃ¼lsamed'in kafasÄ± iÃ§in oyna)
            } 
            else if (bodyKey === 'ninja_bal') {
                // --- GÃœLMÄ°RA AYARLARI ---
                bodyOffset = -50;  // GÃ¼lmira biraz daha yukarÄ±da dursun
                headOffset = -55;  // GÃ¼lmira'nÄ±n kafasÄ± iÃ§in oyna
            }

            // GÃ¶rselleri oluÅŸtur
            const body = this.textures.exists(bodyKey) ? 
                         this.add.image(0, bodyOffset, bodyKey) : 
                         this.add.rectangle(0, bodyOffset, 40, 80, 0x00ff00);
            
            const head = this.add.image(0, headOffset, headKey).setDisplaySize(50,50);
            
            con.add([body, head]);
            return con;
        }

        speak(target, text) {
            const bubble = this.add.graphics().fillStyle(0xffffff).fillRoundedRect(target.x-75, target.y-140, 150, 40, 10);
            const t = this.add.text(target.x, target.y-120, text, {color:'#000', fontSize:'14px'}).setOrigin(0.5);
            this.time.delayedCall(2000, () => { bubble.destroy(); t.destroy(); });
        }
    }

    // --- 3. OYUN SAHNESÄ° ---
    class GameScene extends Phaser.Scene {
        constructor() { super('GameScene'); }

        preload() {
            this.load.image('ground', './ground.png');
            this.load.image('spike', './spike.png');
            this.load.image('kalp', './kalp.png');
            this.load.image('foto1', './foto1.png');
            this.load.image('foto2', './foto2.png');
            this.load.image('foto3', './foto3.png');
        }

        create() {
            const { width, height } = this.scale;
            this.createTextures(); 

            // DeÄŸiÅŸkenler
            this.isGamePaused = false; 
            this.photoIndex = 1; 
            this.isBossActive = false;
            this.bossDefeated = false;
            this.cageHP = 3; 
            this.cageBroken = false;

            // Fizik DÃ¼nyasÄ±
            this.physics.world.setBounds(0, 0, 10000, height);
            this.add.tileSprite(0, 0, width, height, 'sky').setOrigin(0).setScrollFactor(0);
            
            // Gruplar
            this.platforms = this.physics.add.staticGroup();
            this.spikes = this.physics.add.staticGroup();
            this.enemies = this.physics.add.group(); 
            this.memories = this.physics.add.staticGroup();
            this.magicBalls = this.physics.add.group();

            // Zemin
            const groundKey = this.textures.exists('ground') ? 'ground' : 'gen_ground';
            for (let i = 0; i < 200; i++) {
                this.platforms.create(32 + (i*64), height-20, groundKey).refreshBody();
            }

            this.generateLevel(height);

            // AnÄ± Ä°konlarÄ±
            this.spawnMemoryIcon(1200, height - 200); 
            this.spawnMemoryIcon(2800, height - 250); 
            this.spawnMemoryIcon(4400, height - 180); 

            // Karakter
            this.player = this.physics.add.sprite(100, height-150, 'ninja_ben');
            if(!this.textures.exists('ninja_ben')) {
                this.player = this.add.rectangle(100, height-150, 40, 80, 0x00ff00);
                this.physics.add.existing(this.player);
            }
            this.player.body.setSize(40, 80);
            this.player.setCollideWorldBounds(true);
            this.player.body.setGravityY(1000);

            // Kafa ve KÄ±lÄ±Ã§
            this.head = this.add.image(0,0,'kafaben').setDisplaySize(50,50).setDepth(1);
            this.sword = this.add.image(0,0, this.textures.exists('kilic')?'kilic':'gen_sword').setDepth(1).setVisible(false);
            this.isAttacking = false;

            // Kamera
            this.cameras.main.setBounds(0, 0, 10000, height);
            this.cameras.main.startFollow(this.player);

            // Kontroller
            this.createUI(width, height);
            this.cursors = this.input.keyboard.createCursorKeys();
            this.buttons = { left: false, right: false, jump: false };
            this.jumpCount = 0;

            // Ã‡arpÄ±ÅŸmalar
            this.physics.add.collider(this.player, this.platforms, () => { this.jumpCount = 0; });
            this.physics.add.collider(this.enemies, this.platforms);
            
            this.physics.add.overlap(this.player, this.enemies, (p, e) => this.handleCombat(p, e));
            this.physics.add.overlap(this.player, this.spikes, () => this.gameOver());
            this.physics.add.overlap(this.player, this.memories, (p, m) => this.collectMemory(p, m));
            this.physics.add.overlap(this.player, this.magicBalls, (p, ball) => { ball.destroy(); this.takeDamage(); });

            this.score = 0;
            this.scoreText = this.add.text(20, 20, 'PUAN: 0', {fontSize:'24px', stroke:'#000', strokeThickness:4}).setScrollFactor(0);
        }

        generateLevel(h) {
            for(let x = 400; x < 9000; x += Phaser.Math.Between(300, 500)) {
                if(Math.random() < 0.4) {
                    const y = h - Phaser.Math.Between(90, 140); 
                    this.platforms.create(x, y, 'gen_ground').setDisplaySize(100, 30).refreshBody();
                    if(Math.random() < 0.5) this.spawnEnemy(x, y - 50);
                } 
                else if(Math.random() < 0.3) {
                    this.spikes.create(x, h - 50, this.textures.exists('spike')?'spike':'gen_spike');
                }
                else {
                    this.spawnEnemy(x, h - 100); 
                }
            }
        }

        spawnMemoryIcon(x, y) {
            const m = this.memories.create(x, y, 'gen_icon');
            this.tweens.add({ targets: m, y: y - 15, duration: 1500, yoyo: true, repeat: -1, ease: 'Sine.easeInOut' });
        }

        spawnEnemy(x, y) {
            const e = this.enemies.create(x, y, this.textures.exists('iskelet')?'iskelet':'gen_enemy');
            if(this.textures.exists('iskelet')) { e.displayHeight=80; e.scaleX=e.scaleY; e.body.setSize(e.width * 0.6, e.height * 0.8); }
            e.setVelocityX(-50); e.setCollideWorldBounds(true); e.setBounce(1);
        }

        // --- BOSS SAVAÅžI ---
        
        startBossBattle() {
            this.isBossActive = true;
            const camX = this.cameras.main.scrollX;
            const { width, height } = this.scale;

            this.physics.world.bounds.width = camX + width; 
            this.cameras.main.setBounds(camX, 0, width, height);

            const warning = this.add.text(camX + width/2, height/2 - 100, "BOSS GELÄ°YOR!", { fontSize: '40px', color: '#ff0000', fontStyle: 'bold', stroke: '#000', strokeThickness: 6 }).setOrigin(0.5);
            this.tweens.add({ targets: warning, alpha: 0, duration: 2000, onComplete: () => warning.destroy() });

            const bossX = camX + width + 100;
            const bossY = height / 2 - 50;
            
            this.boss = this.physics.add.sprite(bossX, bossY, this.textures.exists('iskelet')?'iskelet':'gen_enemy');
            this.boss.setDisplaySize(150, 150); 
            this.boss.body.allowGravity = false; this.boss.body.setImmovable(true);
            this.boss.hp = 5; 
            this.boss.maxHp = 5;

            this.tweens.add({
                targets: this.boss, x: camX + width - 150, duration: 2000, ease: 'Power2',
                onComplete: () => { this.bossHover(); this.startBossAttack(); }
            });

            this.bossHealthBar = this.add.graphics();
            this.updateBossHealthBar();

            this.physics.add.overlap(this.player, this.boss, () => this.hitBoss());
        }

        bossHover() {
            if(this.bossDefeated) return;
            this.tweens.add({ targets: this.boss, y: this.boss.y + 100, duration: 2000, yoyo: true, repeat: -1, ease: 'Sine.easeInOut' });
        }

        startBossAttack() {
            if(this.bossDefeated) return;
            this.time.addEvent({ delay: 2000, callback: this.bossFire, callbackScope: this, loop: true });
        }

        bossFire() {
            if(this.bossDefeated || !this.boss.active) return;
            const ball = this.magicBalls.create(this.boss.x - 50, this.boss.y, 'gen_magic');
            this.physics.moveToObject(ball, this.player, 300);
            this.tweens.add({ targets: ball, angle: 360, duration: 500, repeat: -1 });
            this.time.delayedCall(3000, () => { if(ball.active) ball.destroy(); });
        }

        hitBoss() {
            if(this.isAttacking && !this.boss.isHit) {
                this.boss.hp--;
                this.boss.isHit = true; 
                this.boss.setTint(0xff0000);
                this.cameras.main.shake(100, 0.01);
                this.updateBossHealthBar();
                this.time.delayedCall(500, () => { if(this.boss.active) this.boss.clearTint(); this.boss.isHit = false; });

                if(this.boss.hp <= 0) {
                    this.victory();
                }
            } else if (!this.isAttacking) {
                this.takeDamage();
            }
        }

        updateBossHealthBar() {
            this.bossHealthBar.clear();
            const x = this.boss.x - 50; const y = this.boss.y - 100;
            this.bossHealthBar.fillStyle(0x000000); this.bossHealthBar.fillRect(x, y, 100, 10);
            const width = (this.boss.hp / this.boss.maxHp) * 100;
            this.bossHealthBar.fillStyle(0xff0000); this.bossHealthBar.fillRect(x, y, width, 10);
        }

        // --- KAFES VE KURTARMA ---

        victory() {
            this.bossDefeated = true;
            const bossX = this.boss.x;
            const bossY = this.boss.y;
            
            this.tweens.add({
                targets: this.boss, scaleX: 0, scaleY: 0, alpha: 0, angle: 360, duration: 1000,
                onComplete: () => {
                    this.boss.destroy();
                    this.bossHealthBar.destroy();
                    this.magicBalls.clear(true, true);
                    this.spawnCage(bossX, bossY);
                }
            });
        }

        spawnCage(x, y) {
            const groundY = this.scale.height - 160; 
            
            this.cage = this.add.container(x, groundY);
            
            const body = this.textures.exists('ninja_bal') ? this.add.image(0, 0, 'ninja_bal') : this.add.rectangle(0,0,40,80,0xff69b4);
            const head = this.add.image(0, 0, 'kafabal').setDisplaySize(50,50); 
            this.cageGulmira = this.add.container(0, 0, [body, head]);
            
            this.tweens.add({ targets: this.cageGulmira, x: 2, duration: 100, yoyo: true, repeat: -1 });

            const bars = this.add.graphics();
            bars.lineStyle(4, 0x555555); bars.strokeRect(-40, -50, 80, 100);
            bars.lineStyle(2, 0x555555);
            bars.beginPath(); bars.moveTo(-20, -50); bars.lineTo(-20, 50); bars.moveTo(0, -50); bars.lineTo(0, 50); bars.moveTo(20, -50); bars.lineTo(20, 50); bars.strokePath();
            
            this.cageGraphics = bars;
            this.cage.add([this.cageGulmira, bars]);
            this.cage.setSize(100, 100);
            
            this.physics.world.enable(this.cage);
            this.cage.body.setImmovable(true);
            this.cage.body.allowGravity = false;

            this.physics.add.collider(this.player, this.cage); 

            this.hitText = this.add.text(x, groundY - 80, "KURTAR BENÄ°!\n(YAKLAÅž VE VUR)", {
                fontSize: '16px', color: '#fff', align: 'center', stroke: '#000', strokeThickness: 3
            }).setOrigin(0.5);
        }

        hitCage() {
            if (this.cageBroken) return;

            if(this.isAttacking && !this.cageHitCooldown) {
                this.cageHP--;
                this.cageHitCooldown = true;

                this.cameras.main.shake(50, 0.005);
                
                this.tweens.add({
                    targets: this.cage, 
                    alpha: 0.5, 
                    x: this.cage.x + 5, 
                    duration: 50, 
                    yoyo: true, 
                    repeat: 3,
                    onComplete: () => {
                        if (this.cage && this.cage.active && !this.cageBroken) {
                            this.cage.alpha = 1; 
                        }
                        this.cageHitCooldown = false;
                    }
                });

                if(this.cageHP <= 0) {
                    this.breakCage();
                }
            }
        }

        breakCage() {
            if (this.cageBroken) return;
            this.cageBroken = true;

            this.tweens.killTweensOf(this.cage);

            if (this.cageGraphics) this.cageGraphics.destroy();
            if (this.hitText) this.hitText.destroy();
            if (this.cage && this.cage.body) this.cage.body.enable = false;

            this.tweens.add({ targets: this.cageGulmira, y: -50, duration: 300, yoyo: true, repeat: 2 });

            const text = this.add.text(this.cage.x, this.cage.y - 100, "SENÄ° KURTARDIM AÅžKIM!", { fontSize: '30px', color: '#00ff00', fontStyle: 'bold', stroke: '#000', strokeThickness: 4 }).setOrigin(0.5);

            this.time.delayedCall(3000, () => {
                this.cameras.main.fadeOut(1000, 0, 0, 0);
                this.cameras.main.once(Phaser.Cameras.Scene2D.Events.FADE_OUT_COMPLETE, () => {
                    this.scene.start('FinalScene');
                });
            });
        }

        takeDamage() {
            this.cameras.main.flash(200, 255, 0, 0);
            this.player.setAlpha(0.5);
            this.time.delayedCall(1000, () => this.player.setAlpha(1));
        }

        collectMemory(player, icon) {
            icon.destroy(); 
            this.score += 500;
            this.scoreText.setText('PUAN: ' + this.score);
            this.physics.pause();
            this.isGamePaused = true;
            this.showPhotoPopup();
        }

        showPhotoPopup() {
            const { width, height } = this.scale;
            const camX = this.cameras.main.scrollX;
            this.popupContainer = this.add.container(camX + width/2, height/2).setDepth(1000);

            const bg = this.add.rectangle(0, 0, width, height, 0x000000, 0.8).setInteractive();
            const photoKey = 'foto' + this.photoIndex;
            const photo = this.textures.exists(photoKey) ? this.add.image(0, -20, photoKey) : this.add.rectangle(0, -20, 300, 200, 0xffffff);
            if(this.textures.exists(photoKey)) photo.setScale(Math.min(350/photo.width, 250/photo.height));

            const frame = this.add.graphics().lineStyle(5, 0xffffff).strokeRect(photo.x - (photo.displayWidth/2)-5, photo.y-(photo.displayHeight/2)-5, photo.displayWidth+10, photo.displayHeight+10);
            const msgs = ["Seni Ã§ok seviyorum bebeÄŸim...", "Her zaman bÃ¶yle birlikte gÃ¼lelim", "Ä°lk yÃ¼zÃ¼k, ama son deÄŸil :)"];
            const text = this.add.text(0, 140, msgs[(this.photoIndex-1)%3], {fontSize:'22px', fontStyle:'italic', align:'center'}).setOrigin(0.5);
            const close = this.add.text(0, 180, "(Devam et)", {fontSize:'14px', color:'#aaa'}).setOrigin(0.5);

            this.popupContainer.add([bg, photo, frame, text, close]);
            this.photoIndex = (this.photoIndex % 3) + 1;

            bg.on('pointerdown', () => this.closePhotoPopup());
        }

        closePhotoPopup() {
            this.popupContainer.destroy();
            this.physics.resume();
            this.isGamePaused = false;
        }

        createUI(w, h) {
            this.createBtn(60, h-60, '<', () => this.buttons.left=true, () => this.buttons.left=false);
            this.createBtn(160, h-60, '>', () => this.buttons.right=true, () => this.buttons.right=false);
            this.createBtn(w-180, h-60, 'âš”ï¸', () => this.attack(), () => {}, 0xff0000);
            this.createBtn(w-60, h-80, 'ðŸ¦˜', () => this.handleJump(), () => this.buttons.jump=false, 0x0000ff);
        }

        createBtn(x, y, txt, downFn, upFn, color=0xffffff) {
            const btn = this.add.container(x, y).setScrollFactor(0).setDepth(100);
            const circle = this.add.circle(0,0,40,color,0.5);
            const t = this.add.text(0,0,txt,{fontSize:'30px'}).setOrigin(0.5);
            btn.add([circle, t]).setSize(80,80).setInteractive();
            btn.on('pointerdown', () => { circle.setAlpha(1); downFn(); });
            btn.on('pointerup', () => { circle.setAlpha(0.5); upFn(); });
            btn.on('pointerout', () => { circle.setAlpha(0.5); upFn(); });
        }

        attack() {
            if(this.isAttacking) return;
            this.isAttacking = true;
            this.sword.visible = true;
            this.tweens.add({ targets: this.sword, angle: this.player.flipX?-135:135, duration:200, yoyo:true, onComplete: () => { this.sword.visible=false; this.isAttacking=false; } });
        }

        handleJump() {
            if(this.player.body.touching.down || this.jumpCount < 2) {
                this.player.setVelocityY(-700); this.jumpCount++;
            }
        }

        handleCombat(player, enemy) {
            if(this.isAttacking) { enemy.destroy(); this.score += 100; this.scoreText.setText('PUAN: ' + this.score); } 
            else { this.gameOver(); }
        }

        gameOver() {
            this.physics.pause();
            this.add.text(this.cameras.main.scrollX + 400, 225, 'OYUN BÄ°TTÄ°', {fontSize:'50px', color:'red', backgroundColor:'#000'}).setOrigin(0.5);
            this.input.once('pointerdown', () => this.scene.restart());
        }

        update() {
            if(this.isGamePaused) return; 

            if(this.score >= 1500 && !this.isBossActive) {
                this.startBossBattle();
            }

            if(this.isBossActive && !this.bossDefeated) {
                this.updateBossHealthBar();
            }

            if (this.cursors.left.isDown || this.buttons.left) {
                this.player.setVelocityX(-200); this.player.flipX = true;
            } else if (this.cursors.right.isDown || this.buttons.right) {
                this.player.setVelocityX(200); this.player.flipX = false;
            } else { this.player.setVelocityX(0); }

            if (Phaser.Input.Keyboard.JustDown(this.cursors.space)) this.handleJump();

            if(this.player.body) {
                this.head.x = this.player.body.center.x; this.head.y = this.player.body.top + 15; this.head.flipX = this.player.flipX;
                const handOffset = this.player.flipX ? -20 : 20;
                this.sword.x = this.player.body.center.x + handOffset; this.sword.y = this.player.body.center.y + 10;
                if(!this.isAttacking) { this.sword.angle = this.player.flipX ? -45 : 45; this.sword.flipX = this.player.flipX; }
            }

            // --- KAFES VURUÅž KONTROLÃœ ---
            if(this.cage && this.cage.active && this.isAttacking) {
                const dist = Phaser.Math.Distance.Between(this.player.x, this.player.y, this.cage.x, this.cage.y);
                if(dist < 120) {
                    this.hitCage();
                }
            }
        }

        createTextures() {
            if(!this.textures.exists('gen_ground')) { const g = this.make.graphics().fillStyle(0x654321).fillRect(0,0,64,64).fillStyle(0x8B4513).fillRect(0,0,32,32).fillRect(32,32,32,32); g.generateTexture('gen_ground', 64, 64); }
            if(!this.textures.exists('gen_spike')) { const s = this.make.graphics().fillStyle(0x888888).fillTriangle(0,30,15,0,30,30); s.generateTexture('gen_spike', 30, 30); }
            if(!this.textures.exists('gen_sword')) { const sw = this.make.graphics().fillStyle(0xcccccc).fillRect(0,0,10,50).fillStyle(0x654321).fillRect(-5,40,20,5); sw.generateTexture('gen_sword', 20, 60); }
            if(!this.textures.exists('gen_enemy')) { const e = this.make.graphics().fillStyle(0xff0000).fillRect(0,0,40,60); e.generateTexture('gen_enemy', 40, 60); }
            if(!this.textures.exists('gen_icon')) {
                const i = this.make.graphics();
                i.fillStyle(0xff0000).fillRect(0,0,50,35); i.lineStyle(2, 0xffffff).strokeRect(0,0,50,35); i.beginPath(); i.moveTo(0,0); i.lineTo(25,18); i.lineTo(50,0); i.strokePath();
                i.generateTexture('gen_icon', 50, 35);
            }
            if(!this.textures.exists('gen_magic')) {
                const m = this.make.graphics();
                m.fillStyle(0x800080).fillCircle(10,10,10); 
                m.lineStyle(2, 0xff00ff).strokeCircle(10,10,10); 
                m.generateTexture('gen_magic', 20, 20);
            }
        }
    }

    // --- 4. FÄ°NAL SAHNESÄ° (FOTO GALERÄ°LÄ° VE AYARLI) ---
    class FinalScene extends Phaser.Scene {
        constructor() { super('FinalScene'); }
        preload() {
            this.load.image('sky', './ParallaxBackground/sky.png');
            this.load.image('kafaben', './kafaben.png');
            this.load.image('kafabal', './kafabal.png');
            this.load.image('ninja_ben', './ninja_ben.png');
            this.load.image('ninja_bal', './ninja_bal.png');
            // Yeni fotoÄŸraflarÄ± yÃ¼kle
            for(let i=1; i<=5; i++) {
                this.load.image('fotoo'+i, './fotoo'+i+'.png');
            }
        }
        create() {
            const { width, height } = this.scale;
            this.add.rectangle(0,0,width,height,0x87CEEB).setOrigin(0);
            if(this.textures.exists('sky')) this.add.image(width/2, height/2, 'sky').setDisplaySize(width,height);

            // BaÅŸlÄ±k (Slayt baÅŸlayÄ±nca gizlenecek)
            this.title = this.add.text(width/2, 100, 'BAL SON â¤ï¸', {fontSize:'50px', fontStyle:'bold', color:'#fff', stroke:'#000', strokeThickness:6}).setOrigin(0.5);

            const benchY = height/2 + 50;
            this.add.rectangle(width/2, benchY, 200, 15, 0x5c3a21);
            this.add.rectangle(width/2-80, benchY+20, 10, 40, 0x3d2b1f);
            this.add.rectangle(width/2+80, benchY+20, 10, 40, 0x3d2b1f);

            // Karakterler
            this.createFullChar(width/2 - 30, benchY, 'ninja_ben', 'kafaben');
            this.createFullChar(width/2 + 30, benchY, 'ninja_bal', 'kafabal');

            // 3 saniye sonra galeriyi baÅŸlat
            this.time.delayedCall(3000, () => this.startSlideshow());
        }

        createFullChar(x, y, bodyKey, headKey) {
            const con = this.add.container(x, y);
            
            // --- FÄ°NAL SAHNESÄ° AYARLARI ---
            let bodyY = -40; 
            let headY = -75;

            if (bodyKey === 'ninja_ben') {
                bodyY = -40; // AbdÃ¼lsamed VÃ¼cut (DeÄŸiÅŸtirebilirsin)
                headY = -60; // AbdÃ¼lsamed Kafa (DeÄŸiÅŸtirebilirsin)
            } else if (bodyKey === 'ninja_bal') {
                bodyY = -65; // GÃ¼lmira VÃ¼cut
                headY = -60; // GÃ¼lmira Kafa
            }

            const body = this.textures.exists(bodyKey) ? this.add.image(0, bodyY, bodyKey) : this.add.rectangle(0,-40,40,80,0x00ff00);
            const head = this.add.image(0, headY, headKey).setDisplaySize(50,50);
            con.add([body, head]);
            
            this.tweens.add({ targets: con, scaleY: 0.98, scaleX: 1.02, duration: 1500, yoyo: true, repeat: -1, ease: 'Sine.easeInOut' });
        }

        startSlideshow() {
            const { width, height } = this.scale;
            
            // Karartma
            this.dimmer = this.add.rectangle(0,0,width,height,0x000000,0).setOrigin(0).setDepth(100);
            this.tweens.add({ targets: this.dimmer, alpha: 0.7, duration: 1000 });

            // AnÄ± Listesi
            this.memories = [
                { img: 'fotoo1', txt: 'BalliÅŸkomla birbirimizi Ã§ocuklar gibi mutlu etmek>>>' },
                { img: 'fotoo2', txt: 'AÅŸkÄ±mÄ±n dgsinde balooo' },
                { img: 'fotoo3', txt: 'Benim dgde balliÅŸkomla Ã¼nlÃ¼ tatlÄ± not:sen daha tatlÄ±sÄ±n hÄ±h' },
                { img: 'fotoo4', txt: 'AÅŸkitomla yÄ±l dÃ¶nÃ¼mÃ¼ kutlamasÄ±Ä±Ä± inÅŸallah nicelerini kutlÄ±ycazz' },
                { img: 'fotoo5', txt: 'NAM NAMMMM' }
            ];

            this.showSlide(0);
        }

        showSlide(index) {
            if (index >= this.memories.length) {
                this.endSlideshow();
                return;
            }

            const { width, height } = this.scale;
            const mem = this.memories[index];

            // Konteyner
            const slide = this.add.container(width/2, height/2).setDepth(101).setAlpha(0);

            // Resim var mÄ± kontrolÃ¼
            const key = this.textures.exists(mem.img) ? mem.img : 'kafaben'; // Yoksa yedek resim
            const img = this.add.image(0, -20, key);
            
            // BoyutlandÄ±rma (Max 300x250)
            const scale = Math.min(300 / img.width, 250 / img.height);
            img.setScale(scale);

            // Beyaz Ã‡erÃ§eve (Polaroid)
            const frameW = img.displayWidth + 20;
            const frameH = img.displayHeight + 60;
            const frame = this.add.graphics();
            frame.fillStyle(0xffffff).fillRect(-frameW/2, -frameH/2 + 10, frameW, frameH);

            // Metin
            const txt = this.add.text(0, img.displayHeight/2 + 15, mem.txt, {
                fontSize: '18px', color: '#000', fontStyle: 'italic', fontFamily: 'Arial'
            }).setOrigin(0.5);

            slide.add([frame, img, txt]);

            // Animasyon: Belir -> Bekle -> Kaybol -> Sonraki
            this.tweens.add({
                targets: slide, alpha: 1, duration: 1000,
                onComplete: () => {
                    this.time.delayedCall(4000, () => {
                        this.tweens.add({
                            targets: slide, alpha: 0, duration: 1000,
                            onComplete: () => {
                                slide.destroy();
                                this.showSlide(index + 1);
                            }
                        });
                    });
                }
            });
        }

        endSlideshow() {
            const { width, height } = this.scale;
            
            // Dimmer'Ä± kaldÄ±r
            this.tweens.add({ targets: this.dimmer, alpha: 0, duration: 1000 });

            // Final MesajÄ±
            const finalMsg = this.add.text(width/2, 100, 'SENÄ° Ã‡OK SEVÄ°YORUM AÅžKIM\nÄ°YÄ° KÄ° VARSIN SEVGÄ°LÄ°MM', {
                fontSize: '32px', color: '#ff0055', fontStyle: 'bold', align: 'center', stroke: '#fff', strokeThickness: 4
            }).setOrigin(0.5).setAlpha(0).setDepth(200);

            this.tweens.add({ targets: finalMsg, alpha: 1, scale: 1.1, duration: 1000, yoyo: true, repeat: -1 });

            // Yeniden Oyna Butonu
            const btn = this.add.text(width/2, height - 80, '(Yeniden Oyna)', {
                fontSize: '20px', color: '#fff'
            }).setOrigin(0.5).setInteractive({ useHandCursor: true }).setAlpha(0).setDepth(200)
              .on('pointerdown', () => location.reload());

            this.tweens.add({ targets: btn, alpha: 1, delay: 1000, duration: 500 });
        }
    }

    const config = {
        type: Phaser.AUTO,
        width: 800, height: 450,
        scale: { mode: Phaser.Scale.FIT, autoCenter: Phaser.Scale.CENTER_BOTH },
        physics: { default: 'arcade', arcade: { gravity: { y: 1000 }, debug: false } },
        scene: [MainMenu, StoryScene, GameScene, FinalScene]
    };

    const game = new Phaser.Game(config);
</script>
</body>
</html>